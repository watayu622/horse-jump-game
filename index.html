<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ— ğŸ´ğŸ—»ğŸ¦…ğŸ†</title>
    <meta property="og:title" content="ğŸè¬¹è³€æ–°å¹´ğŸ åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ—">
    <meta property="og:description" content="ä¸€å¯Œå£«äºŒé·¹ä¸‰èŒ„å­ã‚’é£›ã³è¶Šãˆã‚ï¼ã‚¿ãƒƒãƒ—ã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼">
    <meta property="og:image" content="ogp_v2.png">
    <meta property="og:type" content="website">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#87CEEB">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        #gameCanvas { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #resultCanvas { display: none; }
        .ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .score-board { position: absolute; top: max(8px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); display: flex; gap: 15px; padding: 6px 16px; background: rgba(255,255,255,0.9); border-radius: 20px; font-size: 14px; font-weight: bold; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .high-score { color: #e74c3c; }
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 200; pointer-events: auto; max-width: 95%; max-height: 90%; overflow-y: auto; }
        .overlay.hidden { display: none; }
        .overlay h1 { font-size: 20px; margin-bottom: 8px; color: #333; }
        .overlay p { font-size: 14px; margin-bottom: 6px; color: #666; }
        .overlay .emoji { font-size: 36px; margin-bottom: 8px; }
        .overlay .newyear { font-size: 24px; color: #c41e3a; font-weight: bold; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .overlay .wish { font-size: 22px; color: #c41e3a; font-weight: bold; margin: 15px 0; }
        .start-btn { padding: 10px 30px; font-size: 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 25px; cursor: pointer; margin-top: 6px; }
        .music-btn { padding: 6px 14px; font-size: 12px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 15px; cursor: pointer; margin-top: 8px; }
        .instructions { margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 10px; font-size: 11px; color: #555; text-align: left; }
        .instructions .score-info { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 8px; }
        .tip { margin-top: 8px; padding: 6px 10px; background: #fff3cd; border-radius: 8px; font-size: 11px; color: #856404; }
        .share-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .share-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; background: #06C755; color: white; border: none; border-radius: 18px; text-decoration: none; cursor: pointer; }
        .share-btn svg { width: 18px; height: 18px; }
        .save-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 16px; font-size: 13px; background: #3b82f6; color: white; border: none; border-radius: 18px; cursor: pointer; margin-bottom: 8px; }
        /* .save-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; background: #3b82f6; color: white; border: none; border-radius: 18px; text-decoration: none; cursor: pointer; } */
        .fullscreen-btn { position: absolute; top: max(8px, env(safe-area-inset-top)); right: max(8px, env(safe-area-inset-right)); padding: 6px 10px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 8px; font-size: 12px; z-index: 100; pointer-events: auto; display: none; }
        .help-btn { position: absolute; bottom: max(8px, env(safe-area-inset-bottom)); right: max(8px, env(safe-area-inset-right)); padding: 8px 12px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 20px; font-size: 12px; z-index: 100; pointer-events: auto; cursor: pointer; }
        .help-panel { position: absolute; bottom: max(50px, env(safe-area-inset-bottom) + 40px); right: max(8px, env(safe-area-inset-right)); background: rgba(255,255,255,0.95); padding: 12px; border-radius: 12px; font-size: 11px; color: #333; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: auto; max-width: 200px; }
        .help-panel.hidden { display: none; }
        .help-panel h3 { font-size: 13px; margin-bottom: 6px; color: #667eea; }
        .help-panel p { margin: 4px 0; }
        .result-preview { margin: 10px auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 280px; width: 100%; }
        .countdown { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; font-weight: bold; color: #c41e3a; text-shadow: 4px 4px 8px rgba(0,0,0,0.3); z-index: 300; animation: countPop 0.5s ease-out; }
        .countdown.hidden { display: none; }
        .countdown.go { font-size: 80px; color: #667eea; }
        @keyframes countPop { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @media (hover: hover) and (pointer: fine) { .fullscreen-btn { display: flex; align-items: center; gap: 4px; } }
        @media (max-height: 450px) { 
            .overlay { padding: 10px 15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px; } 
            .overlay .emoji { font-size: 24px; margin: 0; } 
            .overlay .newyear { font-size: 16px; margin: 0 8px; } 
            .overlay .wish { font-size: 14px; margin: 4px; } 
            .overlay h1 { font-size: 16px; margin: 0; } 
            .overlay p { font-size: 12px; margin: 0 6px; } 
            .overlay .start-btn { padding: 6px 16px; font-size: 13px; margin: 0; } 
            .overlay .music-btn { padding: 4px 10px; font-size: 10px; margin: 0 5px; } 
            .overlay .instructions { display: none; } 
            .overlay .tip { display: none; } 
            .overlay .share-section { margin: 4px 0 0 0; padding: 4px 0 0 0; border: none; gap: 6px; } 
            .overlay .share-btn, .overlay .save-btn { padding: 6px 12px; font-size: 11px; }
            .overlay .result-preview { max-width: 120px; margin: 4px; } 
            .score-board { padding: 4px 12px; font-size: 12px; gap: 10px; } 
        }
        @media (max-height: 350px) { 
            .overlay { padding: 8px 12px; gap: 6px; } 
            .overlay .emoji { font-size: 20px; } 
            .overlay .newyear { font-size: 14px; } 
            .overlay .wish { font-size: 12px; }
            .overlay h1 { font-size: 14px; } 
            .overlay .result-preview { max-width: 100px; } 
        }
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .ranking-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; background: #f59e0b; color: white; border: none; border-radius: 18px; cursor: pointer; }
        .ranking-section { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 10px; }
        .ranking-section h3 { font-size: 14px; color: #333; margin-bottom: 8px; }
        .ranking-list { list-style: none; padding: 0; margin: 0; font-size: 12px; }
        .ranking-list li { padding: 4px 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .ranking-list li:last-child { border-bottom: none; }
        .ranking-list .rank { font-weight: bold; color: #667eea; width: 24px; }
        .ranking-list .name { flex: 1; }
        .ranking-list .score { font-weight: bold; color: #c41e3a; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 400; }
        .modal.hidden { display: none; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; box-sizing: border-box; }
        .modal-content h2 { font-size: 20px; margin-bottom: 15px; color: #333; }
        .modal-content p { font-size: 16px; color: #666; margin-bottom: 15px; text-align: center; }
        .modal-content input[type="text"] { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
        .modal-content label { display: flex; align-items: flex-start; gap: 10px; font-size: 13px; color: #666; text-align: left; margin-bottom: 15px; cursor: pointer; line-height: 1.4; }
        .modal-content label input[type="checkbox"] { margin-top: 3px; min-width: 18px; min-height: 18px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .modal-buttons button { padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-size: 15px; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: #ddd; color: #333; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    </style>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <canvas id="resultCanvas" width="600" height="315"></canvas>
    <div class="ui-layer">
        <div class="score-board"><span>ã‚¹ã‚³ã‚¢: <span id="current-score">0</span></span><span>ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="high-score" class="high-score">0</span></span></div>
        <button class="fullscreen-btn" onclick="toggleFullscreen()"><span id="fullscreenText">å…¨ç”»é¢</span></button>
        
        <div class="countdown hidden" id="countdown">3</div>
        
        <button class="help-btn" id="helpBtn" onclick="toggleHelp()">â“ æ“ä½œæ–¹æ³•</button>
        <div class="help-panel hidden" id="helpPanel">
            <h3>æ“ä½œæ–¹æ³•</h3>
            <p>ğŸ“± <strong>ã‚¿ãƒƒãƒ—</strong> or âŒ¨ï¸ <strong>ã‚¹ãƒšãƒ¼ã‚¹</strong></p>
            <p>â†’ ã‚¸ãƒ£ãƒ³ãƒ—ï¼</p>
            <p><strong>é€£ç¶šã‚¿ãƒƒãƒ—ã§å¤šæ®µã‚¸ãƒ£ãƒ³ãƒ—</strong></p>
            <p>ï¼ˆæœ€å¤§3æ®µã¾ã§ï¼‰</p>
            <hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">
            <p>ğŸ†èŒ„å­ +1ç‚¹</p>
            <p>ğŸ—»å¯Œå£« +3ç‚¹</p>
            <p>ğŸ¦…é·¹ +5ç‚¹</p>
        </div>
        
        <div class="overlay" id="startOverlay">
            <div class="emoji">ğŸğŸ´ğŸ</div>
            <div class="newyear">è¬¹è³€æ–°å¹´</div>
            <h1>åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ—</h1>
            <p>ä¸€å¯Œå£«äºŒé·¹ä¸‰èŒ„å­ã‚’é£›ã³è¶Šãˆã‚ï¼</p>
            <button class="start-btn" onclick="startCountdown()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button class="music-btn" id="musicBtn" onclick="toggleMusic()">ğŸ”‡ éŸ³æ¥½OFF</button>
            <div class="instructions"><strong>æ“ä½œ:</strong> ã‚¿ãƒƒãƒ—/ã‚¹ãƒšãƒ¼ã‚¹ ã§ã‚¸ãƒ£ãƒ³ãƒ—<br><strong>é€£ç¶šã‚¿ãƒƒãƒ—ã§å¤šæ®µã‚¸ãƒ£ãƒ³ãƒ—ï¼ï¼ˆæœ€å¤§3æ®µï¼‰</strong><br><div class="score-info"><span>ğŸ†èŒ„å­ +1</span><span>ğŸ—»å¯Œå£« +3</span><span>ğŸ¦…é·¹ +5</span></div></div>
            <div class="tip">ã‚¹ãƒãƒ›ã¯<strong>æ¨ªç”»é¢</strong>ã§ã®ãƒ—ãƒ¬ã‚¤ãŒãŠã™ã™ã‚ï¼</div>
        </div>
        <div class="overlay hidden" id="gameOverOverlay">
            <div class="emoji">ğŸğŸ´ğŸ</div>
            <div class="wish">ä»Šå¹´ã‚‚ã‚¦ãƒãã„ãã¾ã™ã‚ˆã†ã«</div>
            <p style="font-size: 18px; font-weight: bold;">ã‚¹ã‚³ã‚¢: <span id="final-score">0</span>ç‚¹</p>
            <p>ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="final-high-score">0</span></p>
            <p id="obstacle-stats" style="font-size:12px;"></p>
            <img id="resultPreview" class="result-preview" src="" alt="çµæœç”»åƒ">
            <button class="start-btn" onclick="startCountdown()">ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
            <div class="share-section">
                <button class="share-btn" onclick="shareToLine()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg>
                    LINEã§ã‚·ã‚§ã‚¢
                </button>
                <button class="save-btn" onclick="saveResultImage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    çµæœã‚’ä¿å­˜
                </button>
                <p style="font-size: 10px; color: #999; margin: 4px 0 8px 0;">â€»ã‚¹ãƒãƒ›ã®å ´åˆã¯ç”»åƒé•·æŠ¼ã—ã§ä¿å­˜</p>
                <button class="ranking-btn" onclick="showRankingModal()">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å‚åŠ </button>
            </div>
            <div class="ranking-section" id="rankingSection">
                <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h3>
                <ul class="ranking-list" id="rankingList">
                    <li><span class="rank">-</span><span class="name">èª­ã¿è¾¼ã¿ä¸­...</span><span class="score"></span></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆui-layerã®å¤–ã«é…ç½®ï¼‰ -->
    <div class="modal hidden" id="rankingModal">
        <div class="modal-content">
            <h2>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å‚åŠ </h2>
            <p>ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <strong id="modalScore">0</strong>ç‚¹</p>
            <input type="text" id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" maxlength="20">
            <label>
                <input type="checkbox" id="agreeCheckbox">
                <span>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ã‚¹ã‚³ã‚¢ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å…¬é–‹ã•ã‚Œã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™ã€‚ä¸é©åˆ‡ãªåå‰ã¯å‰Šé™¤ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>
            </label>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeRankingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" id="submitRankingBtn" onclick="submitToRanking()" disabled>ç™»éŒ²ã™ã‚‹</button>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================
        // Supabase è¨­å®šï¼ˆã“ã“ã‚’è‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å¤‰æ›´ï¼‰
        // ==========================================
        const SUPABASE_URL = 'https://ywcrnmfpxtefvrvellwe.supabase.co';  // ä¾‹: https://xxxxx.supabase.co
        const SUPABASE_ANON_KEY = 'sb_publishable_lVCbPIy96mctROtqCtkDpQ_BgFfEPgg';  // ä¾‹: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        
        // Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        let supabaseClient = null;
        let supabaseEnabled = false;
        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                supabaseEnabled = true;
            }
        } catch (e) {
            console.log('SupabaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const resultCanvas = document.getElementById('resultCanvas');
        const resultCtx = resultCanvas.getContext('2d');
        
        let W, H, refSize, groundY = 0;
        let gameRunning = false, score = 0, highScore = localStorage.getItem('horseGameHighScore') || 0;
        let gameSpeed = 3, baseSpeed = 3, animationId, frameCount = 0;
        let fujiCount = 0, hawkCount = 0, eggplantCount = 0;
        document.getElementById('high-score').textContent = highScore;
        const horse = { x: 0, y: 0, width: 0, height: 0, velocityY: 0, gravity: 0, jumpForce: 0, isJumping: false, jumpCount: 0, maxJumps: 3, groundY: 0, legPhase: 0 };
        let obstacles = [], clouds = [];
        const OBSTACLE_SIZES = { EGGPLANT: { width: 0.035, height: 0.05 }, FUJI: { width: 0.16, height: 0.18 }, HAWK: { width: 0.10, height: 0.05 } };
        const OBSTACLE_TYPES = { EGGPLANT: { type: 'eggplant', score: 1, minSpeed: 0 }, FUJI: { type: 'fuji', score: 3, minSpeed: 0 }, HAWK: { type: 'hawk', score: 5, minSpeed: 4 } };

        let audioCtx = null;
        let musicPlaying = false;
        let musicOscillators = [];
        let musicGain = null;
        let musicStarted = false;
        let resultImageUrl = '';
        
        // ãƒŠã‚¹ç”»åƒã®èª­ã¿è¾¼ã¿
        const eggplantImg = new Image();
        eggplantImg.src = 'eggplant.png';
        let eggplantImgLoaded = false;
        eggplantImg.onload = () => { eggplantImgLoaded = true; };
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        function playNewYearMusic() {
            if (!audioCtx) initAudio();
            if (musicPlaying) return;
            
            musicPlaying = true;
            document.getElementById('musicBtn').textContent = 'ğŸ”‡ éŸ³æ¥½OFF';
            
            musicGain = audioCtx.createGain();
            musicGain.gain.setValueAtTime(0.15, audioCtx.currentTime);
            musicGain.connect(audioCtx.destination);
            
            const melody = [
                { note: 587.33, duration: 0.5 }, { note: 659.25, duration: 0.5 }, { note: 783.99, duration: 0.75 }, { note: 659.25, duration: 0.25 },
                { note: 587.33, duration: 0.5 }, { note: 493.88, duration: 0.5 }, { note: 440.00, duration: 1.0 }, { note: 0, duration: 0.25 },
                { note: 587.33, duration: 0.5 }, { note: 659.25, duration: 0.5 }, { note: 783.99, duration: 0.5 }, { note: 880.00, duration: 0.5 },
                { note: 783.99, duration: 0.75 }, { note: 659.25, duration: 0.25 }, { note: 587.33, duration: 1.0 }, { note: 0, duration: 0.5 },
                { note: 440.00, duration: 0.5 }, { note: 493.88, duration: 0.5 }, { note: 587.33, duration: 0.75 }, { note: 493.88, duration: 0.25 },
                { note: 440.00, duration: 0.5 }, { note: 392.00, duration: 0.5 }, { note: 440.00, duration: 1.5 },
            ];
            
            let time = audioCtx.currentTime;
            const loopDuration = melody.reduce((sum, n) => sum + n.duration, 0);
            
            function scheduleLoop() {
                if (!musicPlaying) return;
                melody.forEach(({ note, duration }) => {
                    if (note > 0) {
                        const osc = audioCtx.createOscillator();
                        const noteGain = audioCtx.createGain();
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(note, time);
                        noteGain.gain.setValueAtTime(0, time);
                        noteGain.gain.linearRampToValueAtTime(0.3, time + 0.05);
                        noteGain.gain.linearRampToValueAtTime(0.2, time + duration * 0.5);
                        noteGain.gain.linearRampToValueAtTime(0, time + duration * 0.95);
                        osc.connect(noteGain);
                        noteGain.connect(musicGain);
                        osc.start(time);
                        osc.stop(time + duration);
                        musicOscillators.push(osc);
                    }
                    time += duration;
                });
                setTimeout(() => { if (musicPlaying) { time = audioCtx.currentTime; scheduleLoop(); } }, loopDuration * 1000 - 100);
            }
            scheduleLoop();
        }
        
        function stopMusic() {
            musicPlaying = false;
            document.getElementById('musicBtn').textContent = 'ğŸµ éŸ³æ¥½ON';
            musicOscillators.forEach(osc => { try { osc.stop(); } catch(e) {} });
            musicOscillators = [];
            if (musicGain) musicGain.gain.setValueAtTime(0, audioCtx.currentTime);
        }
        
        function toggleMusic() {
            initAudio();
            if (musicPlaying) stopMusic(); else playNewYearMusic();
        }
        
        function tryAutoPlayMusic() {
            if (musicStarted) return;
            musicStarted = true;
            initAudio();
            playNewYearMusic();
        }
        
        function playJumpSound(jumpNum) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const baseFreq = 400 + (jumpNum - 1) * 150;
            osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.5, audioCtx.currentTime + 0.1);
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.15);
        }
        
        function playCountdownSound(num) {
            if (!audioCtx) initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (num === 'go') {
                // é™¤å¤œã®é˜ã®éŸ³ï¼ˆä½ã„é˜ã®éŸ³ + å€éŸ³ + é•·ã„ä½™éŸ»ï¼‰
                const baseFreq = 85; // ä½ã„é˜ã®åŸºéŸ³
                const duration = 8.0; // é•·ã„ä½™éŸ»
                
                // åŸºéŸ³
                osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + duration);
                
                // å€éŸ³1ï¼ˆ2å€ï¼‰
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.connect(gain2);
                gain2.connect(audioCtx.destination);
                osc2.frequency.setValueAtTime(baseFreq * 2.4, audioCtx.currentTime);
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.25, audioCtx.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration * 0.7);
                osc2.start(audioCtx.currentTime);
                osc2.stop(audioCtx.currentTime + duration * 0.7);
                
                // å€éŸ³2ï¼ˆé«˜ã‚ï¼‰
                const osc3 = audioCtx.createOscillator();
                const gain3 = audioCtx.createGain();
                osc3.connect(gain3);
                gain3.connect(audioCtx.destination);
                osc3.frequency.setValueAtTime(baseFreq * 4.2, audioCtx.currentTime);
                osc3.type = 'sine';
                gain3.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gain3.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration * 0.5);
                osc3.start(audioCtx.currentTime);
                osc3.stop(audioCtx.currentTime + duration * 0.5);
                
                // ã‚¢ã‚¿ãƒƒã‚¯éŸ³ï¼ˆé˜ã‚’çªã„ãŸç¬é–“ï¼‰
                const osc4 = audioCtx.createOscillator();
                const gain4 = audioCtx.createGain();
                osc4.connect(gain4);
                gain4.connect(audioCtx.destination);
                osc4.frequency.setValueAtTime(baseFreq * 6, audioCtx.currentTime);
                osc4.type = 'triangle';
                gain4.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain4.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc4.start(audioCtx.currentTime);
                osc4.stop(audioCtx.currentTime + 0.15);
            } else {
                const freq = 440 + (4 - num) * 110;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }
        
        function startCountdown() {
            initAudio();
            stopMusic();
            
            document.getElementById('startOverlay').classList.add('hidden');
            document.getElementById('gameOverOverlay').classList.add('hidden');
            document.getElementById('helpPanel').classList.add('hidden');
            
            const countdownEl = document.getElementById('countdown');
            countdownEl.classList.remove('hidden', 'go');
            
            setupDimensions();
            draw();
            
            let count = 3;
            countdownEl.textContent = count;
            playCountdownSound(count);
            
            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                    countdownEl.style.animation = 'none';
                    countdownEl.offsetHeight;
                    countdownEl.style.animation = 'countPop 0.5s ease-out';
                    playCountdownSound(count);
                } else if (count === 0) {
                    countdownEl.textContent = 'GO!';
                    countdownEl.classList.add('go');
                    countdownEl.style.animation = 'none';
                    countdownEl.offsetHeight;
                    countdownEl.style.animation = 'countPop 0.5s ease-out';
                    playCountdownSound('go');
                } else {
                    clearInterval(countInterval);
                    countdownEl.classList.add('hidden');
                    startGame();
                }
            }, 800);
        }
        
        function toggleHelp() {
            const panel = document.getElementById('helpPanel');
            panel.classList.toggle('hidden');
        }
        
        function generateResultImage() {
            const w = 600, h = 315;
            resultCanvas.width = w;
            resultCanvas.height = h;
            
            const bgGrad = resultCtx.createLinearGradient(0, 0, 0, h);
            bgGrad.addColorStop(0, '#FFF8E7');
            bgGrad.addColorStop(0.5, '#FFF5E0');
            bgGrad.addColorStop(1, '#FFECD2');
            resultCtx.fillStyle = bgGrad;
            resultCtx.fillRect(0, 0, w, h);
            
            resultCtx.strokeStyle = '#c41e3a';
            resultCtx.lineWidth = 4;
            resultCtx.strokeRect(10, 10, w - 20, h - 20);
            
            resultCtx.strokeStyle = '#d4a574';
            resultCtx.lineWidth = 2;
            resultCtx.strokeRect(18, 18, w - 36, h - 36);
            
            resultCtx.font = 'bold 28px "Hiragino Mincho ProN", "Yu Mincho", serif';
            resultCtx.fillStyle = '#c41e3a';
            resultCtx.textAlign = 'center';
            resultCtx.fillText('è¬¹è³€æ–°å¹´', w / 2, 55);
            
            resultCtx.font = 'bold 22px "Hiragino Mincho ProN", "Yu Mincho", serif';
            resultCtx.fillStyle = '#333';
            resultCtx.fillText('ä»Šå¹´ã‚‚ã‚¦ãƒãã„ãã¾ã™ã‚ˆã†ã«', w / 2, 95);
            
            resultCtx.font = '50px sans-serif';
            resultCtx.fillText('ğŸ´', w / 2, 160);
            
            resultCtx.font = 'bold 36px sans-serif';
            resultCtx.fillStyle = '#c41e3a';
            resultCtx.fillText(score + ' ç‚¹', w / 2, 210);
            
            resultCtx.font = '20px sans-serif';
            resultCtx.fillStyle = '#555';
            resultCtx.fillText('ğŸ†' + eggplantCount + '  ğŸ—»' + fujiCount + '  ğŸ¦…' + hawkCount, w / 2, 245);
            
            resultCtx.font = '16px sans-serif';
            resultCtx.fillStyle = '#667eea';
            resultCtx.fillText('åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ— - ä»¤å’Œå…«å¹´ åˆå¹´', w / 2, 280);
            
            return resultCanvas.toDataURL('image/png');
        }
        
        function shareToLine() {
            const gameUrl = window.location.href;
            const text = 'ğŸ´åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ—\nä»Šå¹´ã‚‚ã‚¦ãƒãã„ãã¾ã™ã‚ˆã†ã«\nã‚¹ã‚³ã‚¢: ' + score + 'ç‚¹ï¼\nğŸ†' + eggplantCount + ' ğŸ—»' + fujiCount + ' ğŸ¦…' + hawkCount + '\n\nâ–¶ éŠã‚“ã§ã¿ã‚‹:';
            
            const lineUrl = 'https://social-plugins.line.me/lineit/share?url=' + encodeURIComponent(gameUrl) + '&text=' + encodeURIComponent(text);
            window.open(lineUrl, '_blank');
        }
        
        async function shareOrSaveImage() {
            // ãƒ‡ãƒ¼ã‚¿URLã‚’Blobã«å¤‰æ›
            const response = await fetch(resultImageUrl);
            const blob = await response.blob();
            const file = new File([blob], 'åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ—_' + score + 'ç‚¹.png', { type: 'image/png' });
            
            // Web Share APIãŒä½¿ãˆã‚‹ã‹ç¢ºèªï¼ˆã‚¹ãƒãƒ›ï¼‰
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ—çµæœ',
                        text: 'ä»Šå¹´ã‚‚ã‚¦ãƒãã„ãã¾ã™ã‚ˆã†ã«ï¼ ã‚¹ã‚³ã‚¢: ' + score + 'ç‚¹'
                    });
                } catch (e) {
                    if (e.name !== 'AbortError') console.log('Share failed:', e);
                }
            } else {
                // PCã®å ´åˆã¯ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const link = document.createElement('a');
                link.download = 'åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ—_' + score + 'ç‚¹.png';
                link.href = resultImageUrl;
                link.click();
            }
        }
        
        function saveResultImage() {
            const link = document.createElement('a');
            link.download = 'åˆå¤¢ã‚¸ãƒ£ãƒ³ãƒ—_' + score + 'ç‚¹.png';
            link.href = resultImageUrl;
            link.click();
        }

        function setupDimensions() {
            W = window.innerWidth; H = window.innerHeight;
            canvas.width = W; canvas.height = H;
            groundY = H * 0.85; refSize = Math.min(W, H);
            horse.width = refSize * 0.15; horse.height = horse.width * 0.75;
            horse.x = W * 0.15;
            horse.groundY = groundY - horse.height - 5;
            if (!horse.isJumping) horse.y = horse.groundY;
            horse.gravity = H * 0.0012; horse.jumpForce = -H * 0.020;
            baseSpeed = Math.max(2, W * 0.003);
            clouds = [];
            for (let i = 0; i < 5; i++) clouds.push({ x: W * (i / 5) + Math.random() * (W * 0.15), y: H * (0.08 + Math.random() * 0.15), size: refSize * (0.03 + Math.random() * 0.02) });
        }

        function drawHorse() {
            const x = horse.x, y = horse.y, s = horse.height / 60;
            ctx.save(); ctx.fillStyle = '#8B4513';
            // èƒ´ä½“
            ctx.beginPath(); ctx.ellipse(x + 40*s, y + 25*s, 35*s, 20*s, 0, 0, Math.PI * 2); ctx.fill();
            // é¡”ï¼ˆæ¨ªé•·ã«èª¿æ•´ï¼‰
            ctx.beginPath(); ctx.ellipse(x + 80*s, y + 8*s, 22*s, 10*s, -0.2, 0, Math.PI * 2); ctx.fill();
            // é¦–
            ctx.beginPath(); ctx.moveTo(x + 55*s, y + 10*s); ctx.quadraticCurveTo(x + 70*s, y + 20*s, x + 65*s, y + 30*s); ctx.lineTo(x + 55*s, y + 25*s); ctx.quadraticCurveTo(x + 55*s, y + 15*s, x + 55*s, y + 10*s); ctx.fill();
            // è€³
            ctx.beginPath(); ctx.moveTo(x + 75*s, y - 2*s); ctx.lineTo(x + 78*s, y - 12*s); ctx.lineTo(x + 83*s, y - 1*s); ctx.fill();
            // ç›®
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(x + 88*s, y + 5*s, 3*s, 0, Math.PI * 2); ctx.fill();
            // ãŸã¦ãŒã¿ï¼ˆé¦–ã®ä¸Šéƒ¨ã«é…ç½®ï¼‰
            ctx.fillStyle = '#4a2c0a'; 
            ctx.beginPath(); 
            ctx.moveTo(x + 75*s, y - 2*s); 
            ctx.quadraticCurveTo(x + 65*s, y - 8*s, x + 60*s, y + 5*s); 
            ctx.quadraticCurveTo(x + 55*s, y - 5*s, x + 50*s, y + 10*s); 
            ctx.quadraticCurveTo(x + 45*s, y + 5*s, x + 45*s, y + 18*s); 
            ctx.lineTo(x + 55*s, y + 15*s); 
            ctx.quadraticCurveTo(x + 60*s, y + 5*s, x + 75*s, y - 2*s);
            ctx.fill();
            // è¶³
            ctx.fillStyle = '#8B4513'; const lo = horse.isJumping ? 0 : Math.sin(horse.legPhase) * 8 * s;
            ctx.fillRect(x + 55*s, y + 35*s, 8*s, 25*s + lo); ctx.fillRect(x + 65*s, y + 35*s, 8*s, 25*s - lo); ctx.fillRect(x + 15*s, y + 35*s, 8*s, 25*s - lo); ctx.fillRect(x + 25*s, y + 35*s, 8*s, 25*s + lo);
            // è¹„
            ctx.fillStyle = '#2d1b0e'; ctx.fillRect(x + 54*s, y + 58*s + lo, 10*s, 5*s); ctx.fillRect(x + 64*s, y + 58*s - lo, 10*s, 5*s); ctx.fillRect(x + 14*s, y + 58*s - lo, 10*s, 5*s); ctx.fillRect(x + 24*s, y + 58*s + lo, 10*s, 5*s);
            // å°»å°¾
            ctx.fillStyle = '#4a2c0a'; ctx.beginPath(); ctx.moveTo(x + 5*s, y + 20*s); ctx.quadraticCurveTo(x - 15*s, y + 35*s, x - 10*s, y + 50*s); ctx.quadraticCurveTo(x - 5*s, y + 45*s, x + 5*s, y + 35*s); ctx.fill();
            ctx.restore();
        }

        function drawFuji(obs) {
            const x = obs.x, h = obs.height, w = obs.width;
            ctx.save(); ctx.fillStyle = '#3d4654';
            ctx.beginPath(); ctx.moveTo(x - w * 0.08, groundY); ctx.lineTo(x + w / 2, groundY - h); ctx.lineTo(x + w * 1.08, groundY); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#4a5568'; ctx.beginPath(); ctx.moveTo(x, groundY); ctx.lineTo(x + w / 2, groundY - h); ctx.lineTo(x + w, groundY); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#FFF'; const sh = h * 0.4, sw = w * 0.5;
            ctx.beginPath(); ctx.moveTo(x + w/2 - sw/2, groundY - h + sh); ctx.lineTo(x + w/2, groundY - h); ctx.lineTo(x + w/2 + sw/2, groundY - h + sh); ctx.lineTo(x + w/2 + sw/3, groundY - h + sh + h * 0.08); ctx.lineTo(x + w/2, groundY - h + sh + h * 0.12); ctx.lineTo(x + w/2 - sw/3, groundY - h + sh + h * 0.08); ctx.closePath(); ctx.fill();
            ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.beginPath(); ctx.moveTo(x + w/2, groundY - h); ctx.lineTo(x + w, groundY); ctx.lineTo(x + w/2, groundY); ctx.closePath(); ctx.fill();
            ctx.restore();
        }

        function drawHawk(obs) {
            const x = obs.x, y = obs.y, sz = obs.width, wp = Math.sin(frameCount * 0.12) * 0.4;
            ctx.save(); ctx.translate(x + sz/2, y);
            ctx.fillStyle = '#5D4037'; ctx.beginPath(); ctx.ellipse(0, 0, sz * 0.45, sz * 0.18, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(sz * 0.4, -sz * 0.05, sz * 0.14, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.moveTo(sz * 0.54, -sz * 0.05); ctx.lineTo(sz * 0.68, 0); ctx.lineTo(sz * 0.54, sz * 0.03); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(sz * 0.44, -sz * 0.08, sz * 0.05, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(sz * 0.45, -sz * 0.08, sz * 0.025, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#6D4C41';
            ctx.beginPath(); ctx.moveTo(sz * 0.2, -sz * 0.05); ctx.quadraticCurveTo(-sz * 0.2, -sz * (0.7 + wp), -sz * 0.5, -sz * 0.2); ctx.quadraticCurveTo(-sz * 0.1, sz * 0.05, sz * 0.2, -sz * 0.05); ctx.fill();
            ctx.beginPath(); ctx.moveTo(sz * 0.2, sz * 0.05); ctx.quadraticCurveTo(-sz * 0.2, sz * (0.7 + wp), -sz * 0.5, sz * 0.2); ctx.quadraticCurveTo(-sz * 0.1, -sz * 0.05, sz * 0.2, sz * 0.05); ctx.fill();
            ctx.fillStyle = '#4E342E'; ctx.beginPath(); ctx.moveTo(-sz * 0.4, 0); ctx.lineTo(-sz * 0.7, -sz * 0.12); ctx.lineTo(-sz * 0.65, 0); ctx.lineTo(-sz * 0.7, sz * 0.12); ctx.closePath(); ctx.fill();
            ctx.restore();
        }

        function drawEggplant(obs) {
            const x = obs.x, h = obs.height, w = obs.width;
            if (eggplantImgLoaded) {
                // ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚Œã°ç”»åƒã‚’æç”»
                ctx.drawImage(eggplantImg, x - w * 0.5, groundY - h * 1.2, w * 2, h * 1.2);
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: çµµæ–‡å­—ã§æç”»
                ctx.font = h + 'px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ†', x + w / 2, groundY - h * 0.1);
            }
        }

        function drawObstacle(obs) { if (obs.type === 'fuji') drawFuji(obs); else if (obs.type === 'hawk') drawHawk(obs); else drawEggplant(obs); }
        function drawClouds() { ctx.fillStyle = 'rgba(255,255,255,0.8)'; clouds.forEach(c => { ctx.beginPath(); ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2); ctx.arc(c.x + c.size * 0.8, c.y - c.size * 0.2, c.size * 0.7, 0, Math.PI * 2); ctx.arc(c.x + c.size * 1.5, c.y, c.size * 0.8, 0, Math.PI * 2); ctx.fill(); }); }
        function drawBackgroundFuji() { ctx.save(); ctx.globalAlpha = 0.25; const fw = W * 0.35, fh = H * 0.5, fx = W * 0.55; ctx.fillStyle = '#6b7280'; ctx.beginPath(); ctx.moveTo(fx, groundY); ctx.lineTo(fx + fw/2, groundY - fh); ctx.lineTo(fx + fw, groundY); ctx.closePath(); ctx.fill(); ctx.fillStyle = '#FFF'; const sh = fh * 0.28; ctx.beginPath(); ctx.moveTo(fx + fw * 0.32, groundY - fh + sh); ctx.lineTo(fx + fw/2, groundY - fh); ctx.lineTo(fx + fw * 0.68, groundY - fh + sh); ctx.closePath(); ctx.fill(); ctx.restore(); }
        function drawGround() { ctx.fillStyle = '#228B22'; ctx.fillRect(0, groundY, W, H - groundY); ctx.strokeStyle = '#1a6b1a'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(W, groundY); ctx.stroke(); }
        function drawSky() { const g = ctx.createLinearGradient(0, 0, 0, groundY); g.addColorStop(0, '#87CEEB'); g.addColorStop(0.7, '#B0E0E6'); g.addColorStop(1, '#98D8C8'); ctx.fillStyle = g; ctx.fillRect(0, 0, W, groundY); }

        function chooseObstacleType() { const t = [OBSTACLE_TYPES.EGGPLANT, OBSTACLE_TYPES.FUJI]; if (gameSpeed >= OBSTACLE_TYPES.HAWK.minSpeed) t.push(OBSTACLE_TYPES.HAWK); const wt = t.map(x => 1 / x.score), tot = wt.reduce((a, b) => a + b, 0); let r = Math.random() * tot; for (let i = 0; i < t.length; i++) { r -= wt[i]; if (r <= 0) return t[i]; } return t[0]; }
        function createObstacle() { const ti = chooseObstacleType(), obs = { type: ti.type, score: ti.score, x: W + 20, passed: false }; if (ti.type === 'fuji') { obs.width = refSize * OBSTACLE_SIZES.FUJI.width; obs.height = refSize * OBSTACLE_SIZES.FUJI.height; } else if (ti.type === 'hawk') { obs.width = refSize * OBSTACLE_SIZES.HAWK.width; obs.height = refSize * OBSTACLE_SIZES.HAWK.height; const sjh = (horse.jumpForce * horse.jumpForce) / (2 * horse.gravity); obs.y = horse.groundY - sjh * 1.3; } else { obs.width = refSize * OBSTACLE_SIZES.EGGPLANT.width; obs.height = refSize * OBSTACLE_SIZES.EGGPLANT.height; } return obs; }

        function update() {
            frameCount++;
            if (horse.isJumping || horse.y < horse.groundY) { horse.velocityY += horse.gravity; horse.y += horse.velocityY; if (horse.y >= horse.groundY) { horse.y = horse.groundY; horse.velocityY = 0; horse.isJumping = false; horse.jumpCount = 0; } }
            if (!horse.isJumping) horse.legPhase += 0.25;
            const horseRightEdge = horse.x + horse.width;
            obstacles.forEach(obs => { obs.x -= gameSpeed; if (!obs.passed && obs.x + obs.width < horseRightEdge) { obs.passed = true; score += obs.score; if (obs.type === 'fuji') fujiCount++; else if (obs.type === 'hawk') hawkCount++; else eggplantCount++; } });
            obstacles = obstacles.filter(obs => obs.x + obs.width > -50);
            const minGap = Math.max(W * 0.28, W * 0.45 - gameSpeed * W * 0.02), maxGap = Math.max(W * 0.45, W * 0.7 - gameSpeed * W * 0.025);
            const last = obstacles[obstacles.length - 1]; if (!last || last.x < W - minGap - Math.random() * (maxGap - minGap)) obstacles.push(createObstacle());
            clouds.forEach(c => { c.x -= gameSpeed * 0.15; if (c.x + c.size * 2 < 0) c.x = W + c.size; });
            const hb = { x: horse.x + horse.width * 0.2, y: horse.y + horse.height * 0.15, w: horse.width * 0.6, h: horse.height * 0.65 };
            for (const obs of obstacles) { let ob; if (obs.type === 'hawk') { ob = { x: obs.x + obs.width * 0.1, y: obs.y - obs.height * 0.4, w: obs.width * 0.8, h: obs.height * 0.8 }; } else if (obs.type === 'eggplant') { ob = { x: obs.x - obs.width * 0.2, y: groundY - obs.height, w: obs.width * 1.4, h: obs.height }; } else { ob = { x: obs.x + obs.width * 0.15, y: groundY - obs.height, w: obs.width * 0.7, h: obs.height }; } if (hb.x < ob.x + ob.w && hb.x + hb.w > ob.x && hb.y < ob.y + ob.h && hb.y + hb.h > ob.y) { gameOver(); return; } }
            document.getElementById('current-score').textContent = score;
            const maxSpd = baseSpeed * 2.8; if (frameCount % 350 === 0 && gameSpeed < maxSpd) gameSpeed += baseSpeed * 0.06;
        }

        function draw() { drawSky(); drawBackgroundFuji(); drawClouds(); drawGround(); obstacles.forEach(obs => drawObstacle(obs)); drawHorse(); }
        function gameLoop() { if (!gameRunning) return; update(); draw(); animationId = requestAnimationFrame(gameLoop); }
        
        function jump() {
            if (!horse.isJumping && horse.y >= horse.groundY - 5) {
                horse.isJumping = true; horse.velocityY = horse.jumpForce; horse.jumpCount = 1; playJumpSound(1);
            } else if (horse.isJumping && horse.jumpCount < horse.maxJumps) {
                horse.velocityY = horse.jumpForce; horse.jumpCount++; playJumpSound(horse.jumpCount);
            }
        }
        
        function startGame() { 
            gameRunning = true; score = 0; frameCount = 0; fujiCount = 0; hawkCount = 0; eggplantCount = 0; gameSpeed = baseSpeed; obstacles = []; 
            horse.y = horse.groundY; horse.velocityY = 0; horse.isJumping = false; horse.jumpCount = 0; 
            gameLoop(); 
        }
        
        function gameOver() { 
            gameRunning = false; 
            cancelAnimationFrame(animationId); 
            if (score > highScore) { highScore = score; localStorage.setItem('horseGameHighScore', highScore); } 
            document.getElementById('high-score').textContent = highScore; 
            document.getElementById('final-score').textContent = score; 
            document.getElementById('final-high-score').textContent = highScore; 
            document.getElementById('obstacle-stats').textContent = 'ğŸ†' + eggplantCount + ' ğŸ—»' + fujiCount + ' ğŸ¦…' + hawkCount; 
            
            resultImageUrl = generateResultImage();
            document.getElementById('resultPreview').src = resultImageUrl;
            
            document.getElementById('gameOverOverlay').classList.remove('hidden');
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
            fetchRanking();
        }
        
        // ==========================================
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢é€£ã®é–¢æ•°ï¼ˆSupabaseç‰ˆï¼‰
        // ==========================================
        
        async function fetchRanking() {
            try {
                if (!supabaseEnabled) {
                    document.getElementById('rankingList').innerHTML = '<li><span class="name">ãƒ©ãƒ³ã‚­ãƒ³ã‚°æœªè¨­å®š</span></li>';
                    return;
                }
                // SQL: SELECT nickname, score, created_at FROM rankings ORDER BY score DESC LIMIT 10
                const { data, error } = await supabaseClient
                    .from('rankings')
                    .select('nickname, score, created_at')
                    .order('score', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                displayRanking(data);
            } catch (e) {
                console.log('ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                document.getElementById('rankingList').innerHTML = '<li><span class="name">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</span></li>';
            }
        }
        
        function displayRanking(rankings) {
            const list = document.getElementById('rankingList');
            if (!rankings || rankings.length === 0) {
                list.innerHTML = '<li><span class="name">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</span></li>';
                return;
            }
            list.innerHTML = rankings.map((r, i) => 
                `<li><span class="rank">${i + 1}</span><span class="name">${escapeHtml(r.nickname)}</span><span class="score">${r.score}ç‚¹</span></li>`
            ).join('');
        }
        
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function showRankingModal() {
            document.getElementById('modalScore').textContent = score;
            document.getElementById('nicknameInput').value = '';
            document.getElementById('agreeCheckbox').checked = false;
            document.getElementById('submitRankingBtn').disabled = true;
            document.getElementById('rankingModal').classList.remove('hidden');
        }
        
        function closeRankingModal() {
            document.getElementById('rankingModal').classList.add('hidden');
        }
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›ã®ç›£è¦–
        document.addEventListener('DOMContentLoaded', () => {
            const checkbox = document.getElementById('agreeCheckbox');
            const nickname = document.getElementById('nicknameInput');
            const submitBtn = document.getElementById('submitRankingBtn');
            
            function updateSubmitButton() {
                submitBtn.disabled = !(checkbox.checked && nickname.value.trim().length > 0);
            }
            
            checkbox.addEventListener('change', updateSubmitButton);
            nickname.addEventListener('input', updateSubmitButton);
        });
        
        async function submitToRanking() {
            if (!supabaseEnabled) {
                alert('ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const nickname = document.getElementById('nicknameInput').value.trim();
            const agreed = document.getElementById('agreeCheckbox').checked;
            
            if (!nickname || !agreed) return;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (nickname.length > 20) {
                alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç°¡æ˜“çš„ãªä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const ngWords = ['æ­»ã­', 'ãƒã‚«', 'ã‚¢ãƒ›', 'æ®ºã™'];
            if (ngWords.some(word => nickname.includes(word))) {
                alert('ä¸é©åˆ‡ãªãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã™');
                return;
            }
            
            try {
                // SQL: INSERT INTO rankings (nickname, score) VALUES (?, ?)
                const { data, error } = await supabaseClient
                    .from('rankings')
                    .insert([{ nickname: nickname, score: score }]);
                
                if (error) throw error;
                
                closeRankingModal();
                fetchRanking();
                alert('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã—ã¾ã—ãŸï¼');
            } catch (e) {
                console.log('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', e);
                alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            }
        }
        
        function toggleFullscreen() { const el = document.documentElement; if (!document.fullscreenElement) { if (el.requestFullscreen) el.requestFullscreen(); else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); } }

        window.addEventListener('resize', () => { setupDimensions(); if (!gameRunning) draw(); });
        window.addEventListener('orientationchange', () => { setTimeout(() => { setupDimensions(); if (!gameRunning) draw(); }, 150); });
        document.addEventListener('fullscreenchange', () => { setTimeout(() => { setupDimensions(); if (!gameRunning) draw(); }, 100); });
        document.addEventListener('keydown', (e) => { if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); if (gameRunning) jump(); } });
        canvas.addEventListener('click', () => { if (gameRunning) jump(); });
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); if (gameRunning) jump(); }, { passive: false });
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        
        document.addEventListener('click', tryAutoPlayMusic, { once: true });
        document.addEventListener('touchstart', tryAutoPlayMusic, { once: true });
        document.addEventListener('keydown', tryAutoPlayMusic, { once: true });

        setupDimensions(); draw();
    </script>
</body>
</html>
